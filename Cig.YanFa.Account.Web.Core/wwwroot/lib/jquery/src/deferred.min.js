define(["./core","./var/slice","./callbacks"],function(u,f){return u.extend({Deferred:function(e){var o=[["resolve","done",u.Callbacks("once memory"),"resolved"],["reject","fail",u.Callbacks("once memory"),"rejected"],["notify","progress",u.Callbacks("memory")]],t="pending",s={state:function(){return t},always:function(){return c.done(arguments).fail(arguments),this},then:function(){var t=arguments;return u.Deferred(function(i){u.each(o,function(e,n){var r=u.isFunction(t[e])&&t[e];c[n[1]](function(){var e=r&&r.apply(this,arguments);e&&u.isFunction(e.promise)?e.promise().progress(i.notify).done(i.resolve).fail(i.reject):i[n[0]+"With"](this===s?i.promise():this,r?[e]:arguments)})}),t=null}).promise()},promise:function(e){return null!=e?u.extend(e,s):s}},c={};return s.pipe=s.then,u.each(o,function(e,n){var r=n[2],i=n[3];s[n[1]]=r.add,i&&r.add(function(){t=i},o[1^e][2].disable,o[2][2].lock),c[n[0]]=function(){return c[n[0]+"With"](this===c?s:this,arguments),this},c[n[0]+"With"]=r.fireWith}),s.promise(c),e&&e.call(c,c),c},when:function(e){function n(n,r,i){return function(e){r[n]=this,i[n]=1<arguments.length?f.call(arguments):e,i===t?l.notifyWith(r,i):--a||l.resolveWith(r,i)}}var t,r,i,o=0,s=f.call(arguments),c=s.length,a=1!==c||e&&u.isFunction(e.promise)?c:0,l=1===a?e:u.Deferred();if(1<c)for(t=new Array(c),r=new Array(c),i=new Array(c);o<c;o++)s[o]&&u.isFunction(s[o].promise)?s[o].promise().progress(n(o,r,t)).done(n(o,i,s)).fail(l.reject):--a;return a||l.resolveWith(i,s),l.promise()}}),u});